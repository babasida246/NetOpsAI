# Hospital IT Gateway - Deployment Script (Windows PowerShell)
# Usage: .\scripts\deploy.ps1 [environment] [version]
# Example: .\scripts\deploy.ps1 production latest

param(
    [string]$Environment = "production",
    [string]$Version = "latest"
)

$ErrorActionPreference = "Stop"

Write-Host "üöÄ Hospital IT Gateway - Deployment" -ForegroundColor Blue
Write-Host "Environment: $Environment"
Write-Host "Version: $Version"
Write-Host ""

# Get script directory
$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$ProjectRoot = Split-Path -Parent $ScriptDir
Set-Location $ProjectRoot

# Step 1: Check prerequisites
Write-Host "Step 1: Checking prerequisites..." -ForegroundColor Yellow

# Check Docker
if (-not (Get-Command docker -ErrorAction SilentlyContinue)) {
    Write-Host "‚ùå Docker is not installed" -ForegroundColor Red
    exit 1
}
Write-Host "‚úì Docker installed" -ForegroundColor Green

# Check Docker Compose
if (-not (Get-Command docker-compose -ErrorAction SilentlyContinue)) {
    Write-Host "‚ùå Docker Compose is not installed" -ForegroundColor Red
    exit 1
}
Write-Host "‚úì Docker Compose installed" -ForegroundColor Green
Write-Host ""

# Step 2: Load environment
Write-Host "Step 2: Loading environment configuration..." -ForegroundColor Yellow
$EnvFile = ".env.$Environment"
if (-not (Test-Path $EnvFile)) {
    if (Test-Path ".env") {
        $EnvFile = ".env"
        Write-Host "Using .env file" -ForegroundColor Yellow
    }
    else {
        Write-Host "‚ùå $EnvFile not found" -ForegroundColor Red
        Write-Host "Create it from .env.$Environment.example:"
        Write-Host "  Copy-Item .env.$Environment.example .env.$Environment"
        exit 1
    }
}
Write-Host "‚úì Environment file found: $EnvFile" -ForegroundColor Green
Write-Host ""

# Step 3: Build images
Write-Host "Step 3: Building Docker images..." -ForegroundColor Yellow
docker-compose --env-file $EnvFile build
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Build failed" -ForegroundColor Red
    exit 1
}
Write-Host "‚úì Images built" -ForegroundColor Green
Write-Host ""

# Step 4: Stop old containers
Write-Host "Step 4: Stopping old containers..." -ForegroundColor Yellow
docker-compose --env-file $EnvFile down --remove-orphans 2>$null
Write-Host "‚úì Old containers stopped" -ForegroundColor Green
Write-Host ""

# Step 5: Start new containers
Write-Host "Step 5: Starting new containers..." -ForegroundColor Yellow
docker-compose --env-file $EnvFile up -d
if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå Failed to start containers" -ForegroundColor Red
    exit 1
}
Write-Host "‚úì Containers started" -ForegroundColor Green
Write-Host ""

# Step 6: Wait for health checks
Write-Host "Step 6: Waiting for services to be healthy..." -ForegroundColor Yellow
Write-Host "Waiting 15 seconds..."
Start-Sleep -Seconds 15

# Check status
$Status = docker-compose --env-file $EnvFile ps --format "table {{.Service}}\t{{.State}}\t{{.Health}}"
Write-Host $Status
Write-Host ""

# Check for unhealthy
if ($Status -match "unhealthy|Exit") {
    Write-Host "‚ö†Ô∏è  Some services may not be healthy" -ForegroundColor Yellow
    Write-Host "Check logs: docker-compose logs"
}
Write-Host ""

Write-Host "‚úÖ Deployment completed!" -ForegroundColor Green
Write-Host ""
Write-Host "Services:"
Write-Host "  API: http://localhost:3000"
Write-Host "  MCP: http://localhost:3001"
Write-Host ""
Write-Host "Next steps:"
Write-Host "  - Check logs: docker-compose logs -f"
Write-Host "  - Monitor: docker-compose ps"
Write-Host "  - Health: curl http://localhost:3000/health"
