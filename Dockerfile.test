# Multi-stage Dockerfile for Testing
FROM node:20-alpine AS base

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy workspace files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY tsconfig.base.json vitest.config.ts ./

# Copy all package.json files
COPY packages/domain/package.json packages/domain/
COPY packages/domain/tsconfig.json packages/domain/ 
COPY packages/contracts/package.json packages/contracts/
COPY packages/contracts/tsconfig.json packages/contracts/
COPY packages/application/package.json packages/application/
COPY packages/application/tsconfig.json packages/application/
COPY packages/application/vitest.config.ts packages/application/
COPY packages/config/package.json packages/config/
COPY packages/infra-postgres/package.json packages/infra-postgres/
COPY packages/infra-redis/package.json packages/infra-redis/
COPY packages/observability/package.json packages/observability/
COPY packages/providers/package.json packages/providers/
COPY packages/security/package.json packages/security/
COPY packages/testing/package.json packages/testing/ 2>/dev/null || true
COPY packages/tools/package.json packages/tools/
COPY packages/tools/tsconfig.json packages/tools/
COPY packages/tools/vitest.config.ts packages/tools/
COPY apps/api/package.json apps/api/
COPY apps/gateway-mcp/package.json apps/gateway-mcp/
COPY apps/gateway-cli/package.json apps/gateway-cli/

# Install all dependencies (including dev)
RUN pnpm install --frozen-lockfile

# Copy source code
COPY packages/ packages/
COPY apps/ apps/

# Build stage
FROM base AS builder
RUN pnpm -r build

# Test runner stage
FROM builder AS test-runner

# Copy test files
COPY packages/*/tests packages/*/tests/ 2>/dev/null || true
COPY apps/*/tests apps/*/tests/ 2>/dev/null || true

# Set test environment
ENV NODE_ENV=test
ENV CI=true

CMD ["pnpm", "test"]
