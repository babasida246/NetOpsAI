# Quick Reference Guide

## Common Commands

### Installation & Setup

```bash
# Clone and install
git clone <repo> && cd hospital-gateway
pnpm install

# Setup environment
cp .env.example .env
# Edit .env with your OPENROUTER_API_KEY

# Start services
docker-compose up -d

# Build all packages
pnpm build

# Seed database
pnpm --filter gateway-cli dev seed
```

### Development

```bash
# Start API server
pnpm --filter gateway-api dev

# Run tests
pnpm test

# Run specific test
pnpm --filter @application/core test

# Build specific package
pnpm --filter @domain/core build

# Check CLI status
pnpm --filter gateway-cli dev status

# Seed database
pnpm --filter gateway-cli dev seed
```

### Production

```bash
# Build for production
pnpm build

# Start production server
NODE_ENV=production pnpm --filter gateway-api start

# Generate database backup
docker exec hospital-postgres pg_dump hospital_gateway > backup.sql

# Update Docker image
docker pull hospital-gateway:latest
docker run -d hospital-gateway:latest
```

## API Requests

### Simple Chat (v1)

```bash
curl -X POST http://localhost:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "x-user-id: user-1" \
  -d '{
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

### Complex Query with Escalation (v2)

```bash
curl -X POST http://localhost:3000/v2/chat \
  -H "Content-Type: application/json" \
  -H "x-user-id: admin-1" \
  -d '{
    "messages": [
      {"role": "user", "content": "Analyze this complex SQL"}
    ],
    "importance": "high"
  }'
```

### Health Check

```bash
curl http://localhost:3000/health
```

## File Locations

| Item | Path |
|------|------|
| Main README | [README-COMPREHENSIVE.md](../README-COMPREHENSIVE.md) |
| API Docs | [docs/api/API.md](./api/API.md) |
| Architecture | [docs/architecture/ARCHITECTURE.md](./architecture/ARCHITECTURE.md) |
| Setup Guide | [docs/SETUP.md](./SETUP.md) |
| Development | [docs/DEVELOPMENT.md](./DEVELOPMENT.md) |
| Deployment | [docs/DEPLOYMENT.md](./DEPLOYMENT.md) |
| Domain Layer | `packages/domain/src/` |
| Application | `packages/application/src/` |
| Infrastructure | `packages/infra-postgres/`, `packages/infra-redis/` |
| REST API | `apps/gateway-api/src/` |
| MCP Server | `apps/gateway-mcp/src/` |
| CLI | `apps/gateway-cli/src/` |

## Package Dependencies

```
Domain ← Contracts ← Application ← Presentation
    ↓         ↓           ↓            ↓
 (pure)   (interfaces) (logic)    (routes)
```

```
Application
    ↓
Infrastructure (Postgres, Redis, LLM Providers, Logging)
```

## Model Tiers

| Tier | Model | Use Case | Threshold |
|------|-------|----------|-----------|
| **T0** | Mistral | Default | 70% |
| **T1** | Llama 3.3 | Better quality | 80% |
| **T2** | Gemini 2.0 | Complex | 90% |
| **T3** | Gemini 2.0 | Critical | 95% |

## Error Codes

| Code | Meaning | Fix |
|------|---------|-----|
| `VALIDATION_ERROR` | Invalid request | Check request format |
| `RATE_LIMIT_EXCEEDED` | Too many requests | Wait and retry |
| `BUDGET_EXCEEDED` | User quota exhausted | Increase budget or wait |
| `DATABASE_ERROR` | DB connection failed | Check Postgres |
| `SERVICE_UNAVAILABLE` | Service down | Wait or check logs |

## Environment Variables

```bash
# Required
OPENROUTER_API_KEY=sk-or-v1-...
DATABASE_URL=postgresql://...
REDIS_URL=redis://...

# Optional
NODE_ENV=development
PORT=3000
LOG_LEVEL=debug
```

## Git Workflow

```bash
# Create feature branch
git checkout -b feature/my-feature

# Make changes and commit
git add .
git commit -m "feat: add new feature"

# Push to remote
git push origin feature/my-feature

# Create pull request on GitHub
# Get reviewed and merge
```

## Testing Patterns

### Unit Test Template

```typescript
import { describe, it, expect, beforeEach } from 'vitest'

describe('MyClass', () => {
  let instance: MyClass

  beforeEach(() => {
    instance = new MyClass(mockDependency)
  })

  it('does something', () => {
    const result = instance.method()
    expect(result).toBe(expected)
  })
})
```

### Integration Test Template

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'

describe('Integration', () => {
  let container: Container

  beforeAll(async () => {
    container = await createContainer()
  })

  afterAll(async () => {
    await closeContainer(container)
  })

  it('completes full flow', async () => {
    const result = await container.chatOrchestrator.execute(request)
    expect(result).toBeDefined()
  })
})
```

## Debug Tips

### Enable Debug Logging

```bash
LOG_LEVEL=debug pnpm --filter gateway-api dev
```

### Check What Models Are Available

```bash
curl -X GET https://openrouter.ai/api/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY" | jq '.data[] | {name, context_length}'
```

### Test Database Connection

```bash
psql -h localhost -U postgres -d hospital_gateway -c "SELECT version();"
```

### Test Redis Connection

```bash
redis-cli -u redis://localhost:6379 ping
# Should return: PONG
```

### Monitor API Requests

```bash
# Follow logs
docker logs -f hospital-gateway

# Or with jq for JSON parsing
docker logs -f hospital-gateway | jq '.correlationId, .userId, .statusCode'
```

## Performance Metrics

### Expected Performance

- **API Response Time**: < 5 seconds
- **Health Check**: < 100ms
- **Database Query**: < 1 second
- **Cache Hit**: < 10ms
- **Model Inference**: 1-30 seconds (depends on complexity)

### Monitor Performance

```bash
# Time a request
time curl http://localhost:3000/v1/chat/completions ...

# Monitor system resources
docker stats hospital-gateway

# Check slow queries
psql -c "SELECT query, mean_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"
```

## FAQ

### Q: How do I add a new model?

A: Edit `packages/config/src/models.ts` and add to `FREE_MODELS` array.

### Q: How do I change the quality threshold?

A: Edit `packages/application/src/core/types.ts` in `TIER_THRESHOLDS`.

### Q: How do I increase rate limits?

A: Edit `apps/gateway-api/src/container.ts` in `PolicyEngine` config.

### Q: How do I increase budget limits?

A: Edit `apps/gateway-api/src/container.ts` in `PolicyEngine` config.

### Q: How do I add a new endpoint?

A: Create file in `apps/gateway-api/src/routes/`, export route function, add to `server.ts`.

### Q: How do I run tests in watch mode?

A: `pnpm --filter @package/name test -- --watch`

### Q: How do I generate test coverage?

A: `pnpm --filter @package/name test -- --coverage`

## Useful Resources

- **Node.js**: https://nodejs.org/docs/
- **TypeScript**: https://www.typescriptlang.org/docs/
- **Fastify**: https://www.fastify.io/docs/latest/
- **PostgreSQL**: https://www.postgresql.org/docs/
- **Redis**: https://redis.io/documentation/
- **OpenRouter**: https://openrouter.ai/docs
- **Zod**: https://zod.dev/
- **pnpm**: https://pnpm.io/

## Support

### Getting Help

1. Check relevant docs in `docs/` folder
2. Search GitHub issues
3. Ask in GitHub discussions
4. Contact DevOps team

### Reporting Issues

Include:
- Error message and stack trace
- Steps to reproduce
- System info (OS, Node.js version)
- Relevant environment variables (redact secrets)
- API request/response if applicable

## Version Information

```
Project: Hospital IT AI Gateway
Version: 4.0.0 (Phase 4 Complete)
Node.js: >= 18
TypeScript: 5.3.0
pnpm: >= 8
Last Updated: December 20, 2025
```

